# 🚀 RAG 프로세스 구축기

> **목표:** 실행 가능한 **RAG(Retrieval-Augmented Generation)** 를 구축하는 것.

![Status](https://img.shields.io/badge/Status-In%20Progress-yellow)
![Deadline](https://img.shields.io/badge/Deadline-24.12.20-red)
![Focus](https://img.shields.io/badge/Focus-Accuracy%20%26%20Usability-blue)

---

## 📖 목차

1. [프로젝트 소개](#-프로젝트-소개)
2. [전체 프로세스](#-전체-프로세스)
   - [데이터 처리](#데이터-처리-문서-기준-설명)
   - [질의 처리](#질의-처리)
3. [현재 상황](#-현재-상황)
4. [해야할 일](#-해야할-일)
5. [추가적인 사용성 고민](#-추가적인-사용성-고민)

---

## 📌 프로젝트 소개

- 고전 방식이든 최신 기술이든 **실행 가능한 RAG**를 구축하는 것을 목표로 합니다.
- **도커**를 활용하여 어느 환경에서든 쉽게 접근 가능하도록 설계합니다.
- 성능 개선은 시간이 지나도 지속적으로 이루어질 예정입니다.

---

## 실행하는 법

### 주의 사항

- 프로젝트 폴더에 **.env** 파일이 있는지 확인하세요.
- .env 파일에는 **OPENAI_API_KEY**, **GOOGLE_API_KEY**, **RETRIEVER_TYPE** 이 있어야합니다.
- RETREIEVER_TYPE에는 ensemble이라고 넣어주세요.
- OPENAI_API_KEY는 embedding에 사용됩니다. (embedding은 벡터DB에 데이터를 저장하려고 처리하는거라 생각하세요.)
- GOOGLE_API_KEY는 llm에 질문하는데 사용한다고 생각하세요. (스플리터에서도 사용합니다.)
- 왜 2가지 다 사용했냐면, GOOGLE 즉 GEMINI는 1분에 15회 제한이 있지만 **api횟수와 상관없이 무료** 입니다.

### Dcoker로 실행

- Dcoker를 설치해주세요. (각 운영체제에 맞게 처리해주세요.)
- 프로젝트 폴더에서 docker-compose up -d --build라고 실행해주세요.
- 모든 과정이 끝나면 http://localhost:8501/ 으로 접속해보세요~

---

## 📂 전체 프로세스

### 데이터 처리 (문서 기준 설명)

> 데이터 처리는 **RAG의 핵심** 입니다.

1. **문서 읽기**: 입력된 문서를 시스템에서 읽어옵니다.
2. **청킹(Chunking)**: 문서를 작은 단위로 나눕니다. (Splitter 사용)
3. **벡터 변환**: Embedding을 이용해 텍스트를 벡터로 변환.
4. **벡터 저장**: 변환된 벡터를 벡터스토어(DB)에 저장.

---

### 질의 처리

1. **데이터 검색**: Retriever를 사용해 적합한 데이터를 가져옵니다.
2. **유사도 확인**: 가져온 데이터의 유사도를 검증합니다.
3. **답변 구성**: 최종적으로 적합한 답변을 생성합니다.

---

## 🛠 현재 상황

- 전체 프로세스는 **구축 완료**.
- 그러나 **정확도가 부족**하여 개선이 필요:
  - Loader → Splitter → Embedding 순으로 검토 중. → ✅ 처리 완료.
  - Retriever를 수정하여 결과물을 개선할 예정. → ✅ 처리 완료.
  - Reranker를 적용할 예정.

---

## ✅ 해야할 일

### 주요 작업

- [x] 문서를 OCR 처리하고 메타데이터를 생성.
- [x] 전처리 과정을 점검 및 문제 파악.
- [x] 청킹 단위를 조정해 메타데이터와의 연동 검토.
- [x] LLM을 이용한 청킹 구성.
- [x] 벡터 저장 및 검색 최적화.
- [x] Retriver를 통한 정상 작동 확인.
- [ ] **기존 로직과의 성능 비교** (24.12.11에 적어놓음)

### 1차 추가 작업 (목표 24.12.20 -> 완료 24.12.16)

- [x] UI 개선:
  - [x] 업로드 방식으로 변경.
  - [x] 파일 리스트 확인 및 채팅 기능 구현.
  - [x] 파일 리스트 삭제 기능 추가.
- [x] Splitter 개선:
  - [x] 분할 텍스트 범위를 반환하도록 수정.
  - [x] 프롬프트 및 메타데이터 최적화.
- [x] 벡터 처리 오류 수정:
  - [x] 중복 저장 문제 해결.
  - [x] 벡터스토어 인자값 처리 오류 수정.
  - [x] 파일 리스트 갱신 문제 해결.
- [x] 파일리스트 업데이트 처리
  - 벡터DB를 바꾸거나 리셋할때, 해당 파일리스트들도 업데이트 되어야한다.
  - 적어보니 벡터DB를 리셋하는것도 만들어야겠다.
  - [x] 파일리스트 업데이트 처리 완료

---

## 💡 추가적인 사용성 고민 (2차)

- **파일 업로드 방식으로 전환**: 폴더 감시 방식에서 업로드 방식으로 변경 → ✅ 처리 완료.
- **전처리된 문서 미저장**: BM25 등을 활용한 실시간 처리 → ✅ 처리 완료.

- [ ] 벡터DB reset 로직 구현
- [ ] **Reranker 적용**:
  - 현재 사용해보니, 전통적인 방식의 Retriever로는 많은 문서를 가져와야만 정확한 답변 생성 가능.
  - 많은 reranker를 사용하면, 많은 문서를 가져오는건 동일하지만 거기서, 말그대로 순위를 재조정해주는 역할을하여 더 검색결과를 좋게 만든다.
  - [ ] 기본적인 reranker를 적용해본다.
- [ ] 검색 결과에 출처 붙여서 보여주기
  - 검색이 작동하는걸 확인했으나, 어떤 문서들을 참고해서 답변을 생성했는지는 정확히지않다.
  - 고로 답변을 생성하고나서, 혹은 생성할때 어떤 문서를 참고했는지 처리를 할 수 있었으면 좋겠다.
  - 고민해야할 부분은 LLM에서 답변을 받을떄 json형식으로 받아서, 내가 재구성을 할지, 해당 부분을 LLM에 맡겨보는게 나을지에 대한 판단이다.
- [ ] 파일을 지정하는 부분처리
  - Cursor라는 툴을 사용해보니 (24.12.15부터 사용함), 질문을 할때 파일을 지정할 수 있는 그런 기능이 있었다.
  - 고로 RAG에서도 만약에 내가 찾을 정보가 어디에있다는걸 명확히 안다면, 그 정보를
